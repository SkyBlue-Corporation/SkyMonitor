{% extends "base.html" %}

{% block content %}
<div class="page-content">
    <div class="dashboard-header">
        <h1 class="page-title">
            Tableau de Bord
            <span class="scan-indicator scan-idle" id="scanStatus">
                <i class="fas fa-wifi"></i>
                <span id="scanStatusText">En attente de scan</span>
            </span>
        </h1>
        <div class="time-filter">
            <button class="time-btn active" onclick="setTimeFilter('24h')">24H</button>
            <button class="time-btn" onclick="setTimeFilter('7j')">7J</button>
            <button class="time-btn" onclick="setTimeFilter('30j')">30J</button>
        </div>
    </div>

    <!-- Cartes de statistiques -->
    <div class="cards-grid">
        <div class="card fade-in">
            <div class="card-header">
                <h3 class="card-title">Serveurs</h3>
                <div class="card-icon server-icon">
                    <i class="fas fa-server"></i>
                </div>
            </div>
            <div class="card-value" id="server-count">0</div>
        </div>

        <div class="card fade-in delay-1">
            <div class="card-header">
                <h3 class="card-title">Postes de Travail</h3>
                <div class="card-icon workstation-icon">
                    <i class="fas fa-desktop"></i>
                </div>
            </div>
            <div class="card-value" id="workstation-count">0</div>
        </div>

        <div class="card fade-in delay-2">
            <div class="card-header">
                <h3 class="card-title">Conteneurs</h3>
                <div class="card-icon container-icon">
                    <i class="fas fa-box"></i>
                </div>
            </div>
            <div class="card-value" id="container-count">0</div>
        </div>

        <div class="card fade-in delay-3">
            <div class="card-header">
                <h3 class="card-title">Disponibilit√©</h3>
                <div class="card-icon availability-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
            </div>
            <div class="card-value" id="availability-rate">0%</div>
        </div>

        <div class="card fade-in delay-4">
            <div class="card-header">
                <h3 class="card-title">Appareils R√©seau</h3>
                <div class="card-icon network-icon">
                    <i class="fas fa-network-wired"></i>
                </div>
            </div>
            <div class="card-value" id="network-devices">0</div>
            <div class="network-stats">
                <div class="stat-badge">
                    <i class="fas fa-laptop"></i>
                    <span id="online-devices">0 en ligne</span>
                </div>
                <div class="stat-badge">
                    <i class="fas fa-clock"></i>
                    <span id="last-scan">Jamais</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphiques -->
    <div class="charts-container">
        <div class="chart-card fade-in delay-1">
            <div class="chart-header">
                <h3 class="chart-title">R√©partition CPU / M√©moire / Disque</h3>
            </div>
            <canvas id="metricsChart"></canvas>
        </div>
    </div>

    <!-- Liste des appareils r√©seau -->
    <div class="servers-list fade-in delay-3">
        <div class="servers-header">
            <h3 class="servers-title">Appareils R√©seau D√©tect√©s</h3>
            <div>
                <button class="btn btn-primary" id="scan-network">
                    <i class="fas fa-search"></i> Scanner le r√©seau
                </button>
            </div>
        </div>
        <div id="network-devices-list" class="network-list">
            <!-- Fallback HTML brut si JS/API ne r√©pond pas -->
            <table class="table table-simulated">
                <thead>
                    <tr><th>Adresse IP</th><th>Nom</th><th>Marque</th><th>Statut</th></tr>
                </thead>
                <tbody>
                    <tr><td>üåê 192.168.1.201</td><td>Printer-HP</td><td>HP</td><td>üü¢ En ligne</td></tr>
                    <tr><td>üåê 192.168.1.202</td><td>Cam-IP</td><td>Axis</td><td>üî¥ Hors ligne</td></tr>
                    <tr><td>üåê 192.168.1.203</td><td>NAS-Synology</td><td>Synology</td><td>üü¢ En ligne</td></tr>
                    <tr><td>üåê 192.168.1.204</td><td>Switch-Backup</td><td>Cisco</td><td>‚ö™ D√©connect√©</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
let networkData = {
    devices: [],
    stats: {
        servers: 0,
        workstations: 0,
        containers: 0,
        total: 0,
        online: 0,
        availability: 0
    },
    lastScan: null
};

let metricsChart;

// Initialisation
document.addEventListener('DOMContentLoaded', () => {
    initializeWebSocket();
    loadInitialData();

    document.getElementById('scan-network').addEventListener('click', scanNetworkNow);
});

function initializeWebSocket() {
    const socket = io();

    socket.on('connect', () => console.log('Connect√© au serveur WebSocket'));
    
    socket.on('system_metrics', (data) => updateMetricsChart(data));

    socket.on('network_scan', (data) => {
        networkData.devices = data.devices;
        updateNetworkStats(data);
        renderNetworkDevices(data.devices);
    });

    socket.on('network_scan_complete', (data) => {
        networkData.devices = data.devices;
        updateNetworkStats(data);
        renderNetworkDevices(data.devices);
    });
}

async function loadInitialData() {
    try {
        const resServers = await fetch('/api/serveurs');
        const servers = await resServers.json();
        if (!Array.isArray(servers) || servers.length === 0) throw new Error('Pas de serveurs r√©els');
        document.getElementById('server-count').textContent = servers.length;

        const resWorkstations = await fetch('/api/postes');
        const workstations = await resWorkstations.json();
        if (!Array.isArray(workstations) || workstations.length === 0) throw new Error('Pas de postes r√©els');
        document.getElementById('workstation-count').textContent = workstations.length;

        const resContainers = await fetch('/api/conteneurs');
        const containers = await resContainers.json();
        if (!Array.isArray(containers) || containers.length === 0) throw new Error('Pas de conteneurs r√©els');
        document.getElementById('container-count').textContent = containers.length;

        const resNetwork = await fetch('/api/network/devices');
        const devices = await resNetwork.json();
        if (!Array.isArray(devices) || devices.length === 0) throw new Error('Pas de devices r√©els');
        networkData.devices = devices;
        updateNetworkStats({ devices: devices });
        renderNetworkDevices(devices);

    } catch(e) {
        console.warn('Chargement initial: utilisation des donn√©es simul√©es ->', e.message || e);
        // Donn√©es simul√©es de secours
        const fakeServers = [
            { name: 'SRV-Paris', ip_address: '192.168.1.10', brand: 'SuperMicro' },
            { name: 'SRV-Lyon', ip_address: '192.168.1.11', brand: 'Dell' }
        ];
        const fakeWorkstations = [
            { name: 'PC-Admin', ip_address: '192.168.1.101', brand: 'Dell' },
            { name: 'PC-Dev', ip_address: '192.168.1.103', brand: 'Lenovo' },
            { name: 'PC-Compta', ip_address: '192.168.1.102', brand: 'HP' }
        ];
        const fakeContainers = [
            { name: 'nginx-web', image: 'nginx:latest' },
            { name: 'db-mysql', image: 'mysql:8.0' }
        ];
        const fakeDevices = [
            { ip: '192.168.1.201', hostname: 'Printer-HP', status: 'online', brand: 'HP' },
            { ip: '192.168.1.202', hostname: 'Cam-IP', status: 'offline', brand: 'Axis' },
            { ip: '192.168.1.203', hostname: 'NAS-Synology', status: 'online', brand: 'Synology' }
        ];

        document.getElementById('server-count').textContent = fakeServers.length;
        document.getElementById('workstation-count').textContent = fakeWorkstations.length;
        document.getElementById('container-count').textContent = fakeContainers.length;

        networkData.devices = fakeDevices;
        updateNetworkStats({ devices: fakeDevices });
        renderNetworkDevices(fakeDevices);
    }
}

function updateNetworkStats(data) {
    const devices = data.devices;
    const total = devices.length;
    const online = devices.filter(d => d.status === 'online').length;

    document.getElementById('network-devices').textContent = total;
    document.getElementById('online-devices').textContent = online + ' en ligne';
    document.getElementById('last-scan').textContent = new Date().toLocaleTimeString();
}

function renderNetworkDevices(devices) {
    const container = document.getElementById('network-devices-list');
    if(!devices || devices.length === 0) {
        container.innerHTML = `<div class="empty-state">
            <i class="fas fa-network-wired"></i>
            <h3>Aucun appareil d√©tect√©</h3>
            <p>Cliquez sur "Scanner le r√©seau" pour d√©couvrir les appareils connect√©s</p>
        </div>`;
        return;
    }
    container.innerHTML = '';
    devices.forEach(d => {
        const statusClass = d.status === 'online' ? 'status-online' : 'status-offline';
        container.innerHTML += `
        <div class="server-item">
            <div class="server-status ${statusClass}"></div>
            <div class="server-info">
                <div class="server-name">${d.hostname || d.name || 'Unknown'}</div>
                <div class="server-details">${d.ip}${d.brand ? ` ‚Ä¢ ${d.brand}` : ''}</div>
            </div>
        </div>`;
    });
}

async function scanNetworkNow() {
    document.getElementById('scanStatusText').textContent = 'Scan en cours...';
    try {
        const res = await fetch('/api/scan/network', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ network: '10.236.155.88/24' })
        });
        const data = await res.json();
        console.log('Scan termin√©', data);
    } catch(e) {
        console.error(e);
    } finally {
        document.getElementById('scanStatusText').textContent = 'En attente de scan';
    }
}

function updateMetricsChart(data) {
    if(!metricsChart) {
        const ctx = document.getElementById('metricsChart').getContext('2d');
        metricsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [new Date().toLocaleTimeString()],
                datasets: [
                    { label: 'CPU %', data: [data.cpu_percent], borderColor: 'rgb(54, 162, 235)', fill: false },
                    { label: 'M√©moire %', data: [data.memory_percent], borderColor: 'rgb(75, 192, 192)', fill: false },
                    { label: 'Disque %', data: [data.disk_percent], borderColor: 'rgb(255, 99, 132)', fill: false }
                ]
            },
            options: {
                responsive: true,
                animation: false,
                scales: { x: { display: true }, y: { beginAtZero: true, max: 100 } }
            }
        });
    } else {
        metricsChart.data.labels.push(new Date().toLocaleTimeString());
        metricsChart.data.datasets[0].data.push(data.cpu_percent);
        metricsChart.data.datasets[1].data.push(data.memory_percent);
        metricsChart.data.datasets[2].data.push(data.disk_percent);
        if(metricsChart.data.labels.length > 20) metricsChart.data.labels.shift();
        metricsChart.data.datasets.forEach(ds => { if(ds.data.length > 20) ds.data.shift(); });
        metricsChart.update();
    }
}
</script>
{% endblock %}
