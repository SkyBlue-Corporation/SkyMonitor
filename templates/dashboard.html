{% extends "base.html" %}

{% block content %}
<div class="page-content">
    <div class="dashboard-header">
        <h1 class="page-title">
            Tableau de Bord
            <span class="scan-indicator scan-idle" id="scanStatus">
                <i class="fas fa-wifi"></i>
                <span id="scanStatusText">En attente de scan</span>
            </span>
        </h1>
        <div class="time-filter">
            <button class="time-btn active" onclick="setTimeFilter('24h')">24H</button>
            <button class="time-btn" onclick="setTimeFilter('7j')">7J</button>
            <button class="time-btn" onclick="setTimeFilter('30j')">30J</button>
        </div>
    </div>

    <!-- Cartes de statistiques -->
    <div class="cards-grid">
        <div class="card fade-in">
            <div class="card-header">
                <h3 class="card-title">Serveurs</h3>
                <div class="card-icon server-icon">
                    <i class="fas fa-server"></i>
                </div>
            </div>
            <div class="card-value" id="server-count">0</div>
        </div>

        <div class="card fade-in delay-1">
            <div class="card-header">
                <h3 class="card-title">Postes de Travail</h3>
                <div class="card-icon workstation-icon">
                    <i class="fas fa-desktop"></i>
                </div>
            </div>
            <div class="card-value" id="workstation-count">0</div>
        </div>

        <div class="card fade-in delay-2">
            <div class="card-header">
                <h3 class="card-title">Conteneurs</h3>
                <div class="card-icon container-icon">
                    <i class="fas fa-box"></i>
                </div>
            </div>
            <div class="card-value" id="container-count">0</div>
        </div>

        <div class="card fade-in delay-3">
            <div class="card-header">
                <h3 class="card-title">Disponibilité</h3>
                <div class="card-icon availability-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
            </div>
            <div class="card-value" id="availability-rate">0%</div>
        </div>

        <div class="card fade-in delay-4">
            <div class="card-header">
                <h3 class="card-title">Appareils Réseau</h3>
                <div class="card-icon network-icon">
                    <i class="fas fa-network-wired"></i>
                </div>
            </div>
            <div class="card-value" id="network-devices">0</div>
            <div class="network-stats">
                <div class="stat-badge">
                    <i class="fas fa-laptop"></i>
                    <span id="online-devices">0 en ligne</span>
                </div>
                <div class="stat-badge">
                    <i class="fas fa-clock"></i>
                    <span id="last-scan">Jamais</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphiques -->
    <div class="charts-container">
        <div class="chart-card fade-in delay-1">
            <div class="chart-header">
                <h3 class="chart-title">Répartition CPU / Mémoire / Disque</h3>
            </div>
            <canvas id="metricsChart"></canvas>
        </div>
    </div>

    <!-- Liste des appareils réseau -->
    <div class="servers-list fade-in delay-3">
        <div class="servers-header">
            <h3 class="servers-title">Appareils Réseau Détectés</h3>
            <div>
                <button class="btn btn-primary" id="scan-network">
                    <i class="fas fa-search"></i> Scanner le réseau
                </button>
            </div>
        </div>
        <div id="network-devices-list" class="network-list">
            <div class="empty-state">
                <i class="fas fa-network-wired"></i>
                <h3>Aucun appareil détecté</h3>
                <p>Cliquez sur "Scanner le réseau" pour découvrir les appareils connectés</p>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
let networkData = {
    devices: [],
    stats: {
        servers: 0,
        workstations: 0,
        containers: 0,
        total: 0,
        online: 0,
        availability: 0
    },
    lastScan: null
};

let metricsChart;

// Initialisation
document.addEventListener('DOMContentLoaded', () => {
    initializeWebSocket();
    loadInitialData();

    document.getElementById('scan-network').addEventListener('click', scanNetworkNow);
});

function initializeWebSocket() {
    const socket = io();

    socket.on('connect', () => console.log('Connecté au serveur WebSocket'));
    
    socket.on('system_metrics', (data) => updateMetricsChart(data));

    socket.on('network_scan', (data) => {
        networkData.devices = data.devices;
        updateNetworkStats(data);
        renderNetworkDevices(data.devices);
    });

    socket.on('network_scan_complete', (data) => {
        networkData.devices = data.devices;
        updateNetworkStats(data);
        renderNetworkDevices(data.devices);
    });
}

async function loadInitialData() {
    try {
        const resServers = await fetch('/api/serveurs');
        const servers = await resServers.json();
        document.getElementById('server-count').textContent = servers.length;

        const resWorkstations = await fetch('/api/postes');
        const workstations = await resWorkstations.json();
        document.getElementById('workstation-count').textContent = workstations.length;

        const resContainers = await fetch('/api/conteneurs');
        const containers = await resContainers.json();
        document.getElementById('container-count').textContent = containers.length;

        const resNetwork = await fetch('/api/network/devices');
        const devices = await resNetwork.json();
        networkData.devices = devices;
        updateNetworkStats({ devices: devices });
        renderNetworkDevices(devices);

    } catch(e) {
        console.error(e);
    }
}

function updateNetworkStats(data) {
    const devices = data.devices;
    const total = devices.length;
    const online = devices.filter(d => d.status === 'online').length;

    document.getElementById('network-devices').textContent = total;
    document.getElementById('online-devices').textContent = online + ' en ligne';
    document.getElementById('last-scan').textContent = new Date().toLocaleTimeString();
}

function renderNetworkDevices(devices) {
    const container = document.getElementById('network-devices-list');
    if(devices.length === 0) {
        container.innerHTML = `<div class="empty-state">
            <i class="fas fa-network-wired"></i>
            <h3>Aucun appareil détecté</h3>
            <p>Cliquez sur "Scanner le réseau" pour découvrir les appareils connectés</p>
        </div>`;
        return;
    }
    container.innerHTML = '';
    devices.forEach(d => {
        const statusClass = d.status === 'online' ? 'status-online' : 'status-offline';
        container.innerHTML += `
        <div class="server-item">
            <div class="server-status ${statusClass}"></div>
            <div class="server-info">
                <div class="server-name">${d.hostname || 'Unknown'}</div>
                <div class="server-details">${d.ip}</div>
            </div>
        </div>`;
    });
}

async function scanNetworkNow() {
    document.getElementById('scanStatusText').textContent = 'Scan en cours...';
    try {
        const res = await fetch('/api/scan/network', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ network: '10.236.155.88/24' })
        });
        const data = await res.json();
        console.log('Scan terminé', data);
    } catch(e) {
        console.error(e);
    } finally {
        document.getElementById('scanStatusText').textContent = 'En attente de scan';
    }
}

function updateMetricsChart(data) {
    if(!metricsChart) {
        const ctx = document.getElementById('metricsChart').getContext('2d');
        metricsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [new Date().toLocaleTimeString()],
                datasets: [
                    { label: 'CPU %', data: [data.cpu_percent], borderColor: 'rgb(54, 162, 235)', fill: false },
                    { label: 'Mémoire %', data: [data.memory_percent], borderColor: 'rgb(75, 192, 192)', fill: false },
                    { label: 'Disque %', data: [data.disk_percent], borderColor: 'rgb(255, 99, 132)', fill: false }
                ]
            },
            options: {
                responsive: true,
                animation: false,
                scales: { x: { display: true }, y: { beginAtZero: true, max: 100 } }
            }
        });
    } else {
        metricsChart.data.labels.push(new Date().toLocaleTimeString());
        metricsChart.data.datasets[0].data.push(data.cpu_percent);
        metricsChart.data.datasets[1].data.push(data.memory_percent);
        metricsChart.data.datasets[2].data.push(data.disk_percent);
        if(metricsChart.data.labels.length > 20) metricsChart.data.labels.shift();
        metricsChart.data.datasets.forEach(ds => { if(ds.data.length > 20) ds.data.shift(); });
        metricsChart.update();
    }
}
</script>
{% endblock %}
